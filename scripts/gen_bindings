#!/usr/bin/env bash
set -euo pipefail
. "$(dirname "${BASH_SOURCE}")/_base.sh"

_docker_gcc() {
  # TODO: consider pinning gcc image, rather than latest
  docker run --rm \
    -i \
    -v "$PWD":/workspace \
    -v "$(base::abspath ultralight-api)":/ultralight-api \
    gcc:latest \
    gcc "$@"
}

_gcc() {
  _docker_gcc # TODO: change to `gcc` if desired, and/or customize
}

_post_process() {
  cat <<- EOF
    /*
     * WARNING: This file is generated automatically by \`gen_bindings.sh\`.
     * Do not edit this file by hand!
     *
     * See \`README.md\`.
     */

EOF
  sed '/#pragma .*/d'
}

_build_headers() {
  echo '
    #include <AppCore/CAPI.h>
    #include <Ultralight/CAPI.h>
  ' \
    | _docker_gcc \
      -E \
      -P \
      -I ultralight-api \
      -D'__attribute__(x)=' \
      -D '__builtin_va_list=void*' \
      - \
    | _post_process \
    | clang-format \
      > ultralight_cffi/_bindings.h
}

_main() {
  scripts/_init
  _build_headers
  .venv/bin/python scripts/_build.py
  .venv/bin/black ultralight_cffi/_bindings.py
}

_main
